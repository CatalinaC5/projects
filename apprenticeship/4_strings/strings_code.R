## ----message=FALSE, warning=FALSE, cache=FALSE--------------------------------------
library(tidyverse)
library(stringr)
library(dslabs)

head(reported_heights)


## -----------------------------------------------------------------------------------
class(reported_heights$height)


## -----------------------------------------------------------------------------------
x <- as.numeric(reported_heights$height)


## -----------------------------------------------------------------------------------
sum(is.na(x))


## ----warning=FALSE------------------------------------------------------------------
reported_heights |>
  mutate(new_height = as.numeric(height)) |>
  filter(is.na(new_height)) |>
  head(n = 10)


## -----------------------------------------------------------------------------------
problems <- reported_heights |>
  mutate(inches = suppressWarnings(as.numeric(height))) |>
  filter(is.na(inches) | inches < 50 | inches > 84) |>
  pull(height)
length(problems)


## ----echo=FALSE---------------------------------------------------------------------
pattern <- "^\\d\\s*'\\s*\\d{1,2}\\.*\\d*'*\"*$"
str_subset(problems, pattern) |> head(n = 10) |> cat()


## ----echo=FALSE---------------------------------------------------------------------
pattern <- "^[4-6]\\s*[\\.|,]\\s*([0-9]|10|11)$"
str_subset(problems, pattern) |> head(n = 10) |> cat()


## ----echo=FALSE---------------------------------------------------------------------
ind <- which(between(suppressWarnings(as.numeric(problems))/2.54, 54, 81) )
ind <- ind[!is.na(ind)]
problems[ind] |> head(n = 10) |> cat()


## -----------------------------------------------------------------------------------
s <- "Hello!"
s <- 'Hello!'


## ----eval=FALSE---------------------------------------------------------------------
## s <- "10""


## -----------------------------------------------------------------------------------
s <- '10"'


## -----------------------------------------------------------------------------------
s


## -----------------------------------------------------------------------------------
s <- "10\""


## -----------------------------------------------------------------------------------
cat(s)


## -----------------------------------------------------------------------------------
s <- "5'"
s <- '5\''


## -----------------------------------------------------------------------------------
s <- '5\'10"'
s <- "5'10\""


## -----------------------------------------------------------------------------------
pattern <- ","
str_detect(c("1", "10", "100", "1,000", "10,000"), pattern)


## -----------------------------------------------------------------------------------
str_subset(reported_heights$height, "cm")


## -----------------------------------------------------------------------------------
yes <- c("180 cm", "70 inches")
no <- c("180", "70''")
s <- c(yes, no)


## -----------------------------------------------------------------------------------
str_detect(s, "cm") | str_detect(s, "inches")


## -----------------------------------------------------------------------------------
str_detect(s, "cm|inches")


## -----------------------------------------------------------------------------------
yes <- c("5", "6", "5'10", "5 feet", "4'11")
no <- c("", ".", "Five", "six")
s <- c(yes, no)
pattern <- "\\d"
str_detect(s, pattern)


## ----eval = FALSE-------------------------------------------------------------------
## str_view(s, pattern)


## ----eval = FALSE-------------------------------------------------------------------
## str_view(s, pattern, match = NA)


## ----eval = FALSE-------------------------------------------------------------------
## str_view(s, "[56]", match = NA)


## -----------------------------------------------------------------------------------
yes <- as.character(4:7)
no <- as.character(1:3)
s <- c(yes, no)
str_detect(s, "[4-7]")


## ----eval = FALSE-------------------------------------------------------------------
## pattern <- "^\\d$"
## yes <- c("1", "5", "9")
## no <- c("12", "123", " 1", "a4", "b")
## s <- c(yes, no)
## str_view(s, pattern, match = NA)


## ----eval = FALSE-------------------------------------------------------------------
## pattern <- "^\\d{1,2}$"
## yes <- c("1", "5", "9", "12")
## no <- c("123", "a4", "b")
## str_view(c(yes, no), pattern, match = NA)


## -----------------------------------------------------------------------------------
pattern <- "^[4-7]'\\d{1,2}\"$"


## -----------------------------------------------------------------------------------
yes <- c("5'7\"", "6'2\"",  "5'12\"")
no <- c("6,2\"", "6.2\"","I am 5'11\"", "3'2\"", "64")
str_detect(yes, pattern)
str_detect(no, pattern)


## -----------------------------------------------------------------------------------
identical("Hi", "Hi ")


## -----------------------------------------------------------------------------------
pattern_2 <- "^[4-7]'\\s\\d{1,2}\"$"
str_subset(problems, pattern_2)


## -----------------------------------------------------------------------------------
yes <- c("AB", "A1B", "A11B", "A111B", "A1111B")
no <- c("A2B", "A21B")
str_detect(yes, "A1*B")
str_detect(no, "A1*B")


## -----------------------------------------------------------------------------------
data.frame(string = c("AB", "A1B", "A11B", "A111B", "A1111B"),
           none_or_more = str_detect(yes, "A1*B"),
           nore_or_once = str_detect(yes, "A1?B"),
           once_or_more = str_detect(yes, "A1+B"))


## -----------------------------------------------------------------------------------
pattern <- "[^a-zA-Z]\\d"
yes <- c(".3", "+2", "-0","*4")
no <- c("A3", "B2", "C0", "E4")
str_detect(yes, pattern)
str_detect(no, pattern)


## -----------------------------------------------------------------------------------
pattern_without_groups <- "^[4-7],\\d*$"


## -----------------------------------------------------------------------------------
pattern_with_groups <-  "^([4-7]),(\\d*)$"


## -----------------------------------------------------------------------------------
yes <- c("5,9", "5,11", "6,", "6,1")
no <- c("5'9", ",", "2,8", "6.1.1")
s <- c(yes, no)
str_detect(s, pattern_without_groups)
str_detect(s, pattern_with_groups)


## -----------------------------------------------------------------------------------
str_match(s, pattern_with_groups)


## -----------------------------------------------------------------------------------
str_extract(s, pattern_with_groups)


## -----------------------------------------------------------------------------------
pattern <- "^[4-7]'\\d{1,2}\"$"
sum(str_detect(problems, pattern))


## ----eval=FALSE---------------------------------------------------------------------
## problems[c(2, 10, 11, 12, 15)] |> str_view(pattern)


## -----------------------------------------------------------------------------------
str_subset(problems, "inches")


## -----------------------------------------------------------------------------------
str_subset(problems, "''")


## -----------------------------------------------------------------------------------
pattern <- "^[4-7]'\\d{1,2}$"


## -----------------------------------------------------------------------------------
problems |>
  str_replace("feet|ft|foot", "'") |> # replace feet, ft, foot with '
  str_replace("inches|in|''|\"", "") |> # remove all inches symbols
  str_detect(pattern) |>
  sum()


## -----------------------------------------------------------------------------------
pattern <- "^[4-7]\\s*'\\s*\\d{1,2}$"
problems |>
  str_replace("feet|ft|foot", "'") |> # replace feet, ft, foot with '
  str_replace("inches|in|''|\"", "") |> # remove all inches symbols
  str_detect(pattern) |>
  sum()


## -----------------------------------------------------------------------------------
pattern_with_groups <-  "^([4-7]),(\\d*)$"
yes <- c("5,9", "5,11", "6,", "6,1")
no <- c("5'9", ",", "2,8", "6.1.1")
s <- c(yes, no)
str_replace(s, pattern_with_groups, "\\1'\\2")


## -----------------------------------------------------------------------------------
pattern_with_groups <- "^([4-7])\\s*[,\\.\\s+]\\s*(\\d*)$"


## -----------------------------------------------------------------------------------
str_subset(problems, pattern_with_groups) |> head()


## -----------------------------------------------------------------------------------
str_subset(problems, pattern_with_groups) |>
  str_replace(pattern_with_groups, "\\1'\\2") |> head()


## -----------------------------------------------------------------------------------
pattern <- "(?=\\w{8,16})(?=^[a-z|A-Z].*)(?=.*\\d+.*)"


## -----------------------------------------------------------------------------------
s <- "Superman saved a man. The man thanked superman."
str_replace_all(s, "(?<=[Ss]uper)man", "girl")


## -----------------------------------------------------------------------------------
tab <- data.frame(x = c("5'10", "6' 1", "5 ' 9", "5'11\""))


## -----------------------------------------------------------------------------------
patterns <- c(feet = "\\d", "\\s*'\\s*", inches = "\\d{1,2}", ".*")
tab |> separate_wider_regex(x, patterns = patterns)


## -----------------------------------------------------------------------------------
s <- "Hi "
cat(s)
identical(s, "Hi")


## -----------------------------------------------------------------------------------
str_trim("5 ' 9 ")


## -----------------------------------------------------------------------------------
s <- c("Five feet eight inches")
str_to_lower(s)


## -----------------------------------------------------------------------------------
not_inches_or_cm <- function(x, smallest = 50, tallest = 84){
  inches <- suppressWarnings(as.numeric(x))
  is.na(inches) |
    !((inches >= smallest & inches <= tallest) |
        (inches/2.54 >= smallest & inches/2.54 <= tallest))
}


## -----------------------------------------------------------------------------------
problems <- reported_heights |>
  filter(not_inches_or_cm(height)) |>
  pull(height)
length(problems)


## -----------------------------------------------------------------------------------
converted <- problems |>
  str_replace("feet|foot|ft", "'") |>
  str_remove_all("inches|in|''|\"") |>
  str_replace("^([4-7])\\s*[,\\.\\s+]\\s*(\\d*)$", "\\1'\\2")
index <- str_detect(converted, "^[4-7]\\s*'\\s*\\d{1,2}$")
mean(!index)


## -----------------------------------------------------------------------------------
converted[!index]


## ----warning=FALSE, message=FALSE---------------------------------------------------
library(english)
cleanup <- function(s){
  s <- str_remove_all(s, "inches|in|''|\"|cm|and") |>
    str_trim() |>
    str_to_lower()
  for (i in 0:11) {
    s <- str_replace_all(s, words(i), as.character(i))
  }
  return(s)
}


## -----------------------------------------------------------------------------------
convert_format <- function(s){
  s |> str_replace("feet|foot|ft", "'") |>
    str_replace("^([4-7])\\s*[,\\.\\s+]\\s*(\\d*)$", "\\1'\\2") |>
    str_replace("^([56])'?$", "\\1'0") |>
    str_replace("^([12])\\s*,\\s*(\\d*)$", "\\1\\.\\2")
}


## ----warning=FALSE, message=FALSE---------------------------------------------------
patterns <- c(feet = "[4-7](?=\\s*'\\s*)",
              "\\s*'\\s*",
              inches = "\\d+\\.?\\d*")
smallest <- 50
tallest <- 84
new_heights <- reported_heights |>
  mutate(original = height,
         height = convert_format(cleanup(height))) |>
  separate_wider_regex(height, patterns = patterns,
                       too_few = "align_start",
                       cols_remove = FALSE) |>
  mutate(across(c(height, feet, inches), as.numeric)) |>
  mutate(guess = 12 * feet + inches) |>
  mutate(height = case_when(
    is.na(height) ~ as.numeric(NA),
    between(height, smallest, tallest) ~ height,  #inches
    between(height/2.54, smallest, tallest) ~ height/2.54, #cm
    between(height*100/2.54, smallest, tallest) ~ height*100/2.54, #meters
    TRUE ~ as.numeric(NA))) |>
  mutate(height = ifelse(is.na(height) &
                           inches <= 12 & between(guess, smallest, tallest),
                         guess, height)) |>
  select(-feet, -inches, -guess)


## -----------------------------------------------------------------------------------
new_heights |> filter(is.na(height)) |> pull(original)


## -----------------------------------------------------------------------------------
new_heights |> arrange(height) |> head(n = 6)

